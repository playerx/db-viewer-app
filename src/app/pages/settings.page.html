<ion-header>
  <ion-toolbar>
    <ion-title>Settings</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <section class="container">
    <ion-list [inset]="true"
              [lines]="'none'">
      <ion-list-header>
        <ion-label>Active Database</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-label class="ion-text-wrap">
          <h2>{{ tenantService.selectedTenant() ? tenantService.selectedTenant()!.dbName : 'Demo' }}</h2>
          <p>{{ tenantService.selectedTenant() ? tenantService.selectedTenant()!.hostname: '' }}</p>
        </ion-label>
      </ion-item>
    </ion-list>

    @if (identityService.user().verified) {


    <ion-list [inset]="true">
      <ion-list-header>
        <ion-label>Connected Databases</ion-label>
      </ion-list-header>

      @if (tenantService.error()) {
      <ion-item>
        <ion-label color="danger">
          Error: {{ tenantService.error() }}
        </ion-label>
      </ion-item>
      }

      @if (tenantService.loading()) {
      <ion-item>
        <div class="loadingContainer">
          <ion-spinner></ion-spinner>
          <ion-label>Loading connected databases...</ion-label>
        </div>
      </ion-item>
      } @else {
      @if (tenantService.tenants().length === 0) {
      <ion-item>
        <ion-label class="ion-text-wrap">
          <p>No databases configured. Connect to one to get started.</p>
        </ion-label>
      </ion-item>
      } @else {
      @for (tenant of tenantService.tenants(); track tenant.id) {
      <ion-item class="tenantItem">
        <div class="tenantContent">
          <ion-label class="ion-text-wrap">
            <h3>{{ tenant.dbName }}</h3>
            <p>{{ tenant.hostname }}</p>
          </ion-label>
          <div class="tenantActions">
            <ion-button [fill]="tenantService.selectedTenantId() === tenant.id ? 'solid' : 'outline'"
                        [disabled]="tenantService.selectedTenantId() === tenant.id"
                        size="small"
                        (click)="onTenantChange(tenant.id)">
              {{ tenantService.selectedTenantId() === tenant.id ? 'Active' : 'Connect' }}
            </ion-button>
            <ion-button color="danger"
                        fill="clear"
                        size="small"
                        [disabled]="!tenant.userId"
                        (click)="forgetTenant(tenant.id)">
              Forget
            </ion-button>
          </div>
        </div>
      </ion-item>
      }
      }
      }

      <ion-item [button]="true"
                (click)="createTenant()">
        <ion-label color="primary">
          Connect to a new database
        </ion-label>
      </ion-item>

      <ion-note class="listNote">
        All connection strings are stored securely using encryption.
      </ion-note>
    </ion-list>
    } @else {
    <ion-list [inset]="true">
      <ion-list-header>
        <ion-label>Connected Databases</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-label class="ion-text-wrap">
          <h3>Sign In Required</h3>
          <p>Please sign in to access and manage your connected databases.</p>
        </ion-label>
      </ion-item>

      <ion-item [button]="true"
                (click)="signInWithPasskey()">
        <ion-label color="primary">
          Sign In with Passkey
        </ion-label>
      </ion-item>

      <ion-item [button]="true"
                (click)="signInWithEmail()">
        <ion-label color="primary">
          Sign In with Email
        </ion-label>
      </ion-item>

      <ion-note class="listNote">
        Use your device's biometric authentication, security key, or email to sign in securely.
      </ion-note>
    </ion-list>
    }

    <ion-list [inset]="true">
      <ion-list-header>
        <ion-label>Display Settings</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-select [value]="menuService.menuPosition()"
                    (ionChange)="onMenuPositionChange($any($event.detail).value)"
                    label="Menu Position"
                    interface="popover">
          <ion-select-option value="start">Left</ion-select-option>
          <ion-select-option value="end">Right</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-note class="listNote">
        Choose whether the navigation menu appears on the left or right side of the screen.
      </ion-note>
    </ion-list>


    @if (identityService.user().verified) {
    <ion-list [inset]="true">
      <ion-list-header>
        <ion-label>Account</ion-label>
      </ion-list-header>

      <ion-item>
        <ion-label class="ion-text-wrap">
          <h3>{{ identityService.user().name || identityService.user().email }}</h3>
          <p>{{ identityService.user().email }}</p>
        </ion-label>
      </ion-item>

      <ion-item [button]="true"
                (click)="signOut()">
        <ion-label color="danger">
          Sign Out
        </ion-label>
      </ion-item>
    </ion-list>
    }

  </section>
</ion-content>