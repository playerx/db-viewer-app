<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button [text]="collection()"
                       defaultHref="/tabs/data"></ion-back-button>
    </ion-buttons>
    <ion-title>Document Details</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="saveDocument()"
                  [disabled]="loading()">
        @if (loading()) {
        <ion-spinner></ion-spinner>
        } @else {

        Save
        }
      </ion-button>

      <!-- <ion-button color="danger"
                  (click)="deleteDocument()">
        Delete
      </ion-button> -->
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="detailContainer">
    @if (loading() && !document()) {
    <div class="loadingContainer">
      <ion-spinner></ion-spinner>
    </div>
    }

    @if (error()) {
    <div class="errorContainer">
      <p>{{ error() }}</p>
      <ion-button (click)="loadDocument()">Retry</ion-button>
    </div>
    }

    @if (document() && !error()) {
    <div class="monacoEditorContainer">
      @if (!showDiff()) {
      <nu-monaco-editor #editor
                        [ngModel]="jsonString()"
                        (ngModelChange)="modifiedJsonString.set($event);"
                        (event)="onEditorInit($event)"
                        [options]="editorOptions"
                        [height]="'100%'"></nu-monaco-editor>
      } @else {
      @for (key of [diffEditorKey()]; track key) {
      <nu-monaco-diff-editor #diffEditor
                             [old]="diffOldModel()"
                             [new]="diffNewModel()"
                             (event)="onEditorInit($event)"
                             [options]="diffEditorOptions"
                             [height]="'100%'"></nu-monaco-diff-editor>
      }
      }

    </div>

    @if (!promptExpanded()) {
    <ion-fab vertical="bottom"
             horizontal="end"
             slot="fixed">
      <ion-fab-button (click)="togglePrompt()">
        <ion-icon name="chatbubble"></ion-icon>
      </ion-fab-button>
    </ion-fab>
    }

    @if (promptExpanded()) {
    <div class="promptSection">
      <div class="promptInputContainer">
        <ion-textarea [rows]="4"
                      autofocus
                      [placeholder]="'Enter your prompt to transform the document...'"
                      [(ngModel)]="promptText"
                      [disabled]="loading()"></ion-textarea>
        <div class="promptActions">
          <ion-button (click)="runPrompt()"
                      [disabled]="!promptText() || loading()"
                      class="runButton">
            @if (loading()) {
            <ion-spinner></ion-spinner>
            } @else {
            Run
            }
          </ion-button>
          <ion-button fill="outline"
                      size="small"
                      (click)="cancelDiff()">
            Cancel
          </ion-button>
        </div>
      </div>
    </div>
    }
    }
  </div>
</ion-content>