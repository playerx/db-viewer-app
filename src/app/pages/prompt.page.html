<ion-header>
  <ion-toolbar>
    <ion-title>AI Prompt</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">AI Prompt</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="promptContainer">
    <!-- Input Area -->
    <div class="inputArea">
      <ion-textarea [(ngModel)]="prompt"
                    placeholder="Enter your database query in natural language..."
                    [rows]="3"
                    [disabled]="loading()"></ion-textarea>

      <div style="display: flex; gap: 8px;">
        <ion-button expand="block"
                    (click)="executePrompt()"
                    [disabled]="loading() || !prompt()">
          @if (loading()) {
          <ion-spinner slot="start"></ion-spinner>
          }
          {{ loading() ? 'Executing...' : 'Execute' }}
        </ion-button>
        <ion-button fill="outline"
                    (click)="clearPrompt()"
                    [disabled]="loading()">
          Clear
        </ion-button>
      </div>
    </div>

    <!-- Result Display -->
    @if (result()) {
    @for (item of result(); track item.id) {
    <ion-card>
      <ion-card-content>
        <pre>{{ item.query }}</pre>
      </ion-card-content>
      <ion-footer>
        @if (!item.result){
        <ion-button [disabled]="item.isLoading"
                    (click)="runQuery(item)">Run</ion-button>
        }
        @else {
        <pre>{{item.result}}</pre>
        }
      </ion-footer>
    </ion-card>
    }
    }

    <!-- Real-time Updates -->
    @if (updates().length > 0) {
    <ion-card class="updateCard">
      <ion-card-header>
        <ion-card-title>Progress</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        @for (update of updates().reverse(); track $index) {
        <div class="debugStep">
          <strong>{{ update.step }}:</strong>
          <pre>{{ update.content }}</pre>
        </div>
        }
      </ion-card-content>
    </ion-card>
    }

    <!-- Error Display -->
    @if (error()) {
    <ion-card color="danger">
      <ion-card-header>
        <ion-card-title>Error</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        {{ error() }}
      </ion-card-content>
    </ion-card>
    }



    <!-- History -->
    @if (history().length > 0) {
    <ion-card>
      <ion-card-header>
        <ion-card-title>Recent Prompts</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          @for (item of history(); track $index) {
          <ion-item class="historyItem"
                    (click)="loadFromHistory(item)">
            <ion-label>
              <h3>{{ item.prompt }}</h3>
              <p>{{ item.result }}</p>
              <p class="timestamp">{{ item.timestamp | date:'short' }}</p>
            </ion-label>
          </ion-item>
          }
        </ion-list>
      </ion-card-content>
    </ion-card>
    }
  </div>
</ion-content>