<ion-header>
  <ion-toolbar>
    <ion-title>AI Prompt</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">AI Prompt</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="promptContainer">
    <!-- Input Area -->
    <div class="inputArea">
      <ion-textarea [(ngModel)]="prompt"
                    placeholder="Enter your database query in natural language..."
                    [rows]="3"
                    [disabled]="loading()"></ion-textarea>

      <div class="buttonContainer">
        <ion-button expand="block"
                    (click)="executePrompt()"
                    [disabled]="loading() || !prompt()">
          @if (loading()) {
          <ion-spinner slot="start"></ion-spinner>
          }
          {{ loading() ? 'Executing...' : 'Execute' }}
        </ion-button>
        <ion-button fill="outline"
                    (click)="clearPrompt()"
                    [disabled]="loading()">
          Clear
        </ion-button>
      </div>

      <!-- Compact Progress Display -->
      @if (loading() && updates().length > 0) {
      <div class="compactProgress">
        <ion-button fill="clear"
                    size="small"
                    (click)="toggleProgressDetails()">
          {{ currentStep() }}
          <ion-icon [name]="showProgressDetails() ? 'chevron-up' : 'chevron-down'"
                    slot="end"></ion-icon>
        </ion-button>
        @if (showProgressDetails()) {
        <div class="progressDetails">
          @for (update of updates(); track $index) {
          <div class="stepDetail">
            <strong>{{ update.step }}:</strong>
            <pre>{{ update.content }}</pre>
          </div>
          }
        </div>
        }
      </div>
      }
    </div>

    <!-- Error Display -->
    @if (error()) {
    <ion-card color="danger">
      <ion-card-header>
        <ion-card-title>Error</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        {{ error() }}
      </ion-card-content>
    </ion-card>
    }

    <!-- Query Results List -->
    @if (result() && result()!.length > 0) {
    <div class="queryList">
      <h3 class="queryListTitle">Generated Queries</h3>
      @for (item of result(); track item.id) {
      <div class="queryCard">
        <div class="queryContent">
          <pre class="queryText">{{ item.query }}</pre>
          @if (!item.result && !item.error) {
          <ion-button size="small"
                      (click)="runQuery(item)"
                      [disabled]="item.isLoading">
            @if (item.isLoading) {
            <ion-spinner slot="start"></ion-spinner>
            }
            {{ item.isLoading ? 'Running...' : 'Run' }}
          </ion-button>
          }
          @if (item.error) {
          <ion-button size="small"
                      color="danger"
                      fill="outline"
                      (click)="runQuery(item)"
                      [disabled]="item.isLoading">
            @if (item.isLoading) {
            <ion-spinner slot="start"></ion-spinner>
            }
            {{ item.isLoading ? 'Running...' : 'Retry' }}
          </ion-button>
          }
        </div>
        @if (item.result) {
        <div class="queryResult">
          <strong>Result:</strong>
          <pre>{{ item.result }}</pre>
        </div>
        }
        @if (item.error) {
        <div class="queryError">
          <strong>Error:</strong>
          <p>{{ item.error }}</p>
        </div>
        }
      </div>
      }
    </div>
    }

    <!-- History -->
    @if (history().length > 0) {
    <ion-card>
      <ion-card-header>
        <ion-card-title>Recent Prompts</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          @for (item of history(); track $index) {
          <ion-item class="historyItem"
                    (click)="loadFromHistory(item)">
            <ion-label>
              <h3>{{ item.prompt }}</h3>
              <p class="timestamp">{{ item.timestamp | date:'short' }}</p>
            </ion-label>
          </ion-item>
          }
        </ion-list>
      </ion-card-content>
    </ion-card>
    }
  </div>
</ion-content>