<ion-split-pane contentId="main-content">
  <!-- Menu/Sidebar - Collections List -->
  <ion-menu contentId="main-content"
            #menu>
    <ion-header>
      <ion-toolbar>
        <ion-title>Collections</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <ion-refresher slot="fixed"
                     (ionRefresh)="handleRefresh($event)">
        <ion-refresher-content></ion-refresher-content>
      </ion-refresher>

      <ion-searchbar [value]="searchQuery()"
                     (ionInput)="searchQuery.set($any($event.target).value)"
                     placeholder="Search collections"></ion-searchbar>

      @if (loading()) {
      <div class="loadingContainer">
        <ion-spinner></ion-spinner>
      </div>
      } @else if (error()) {
      <div class="emptyState">
        <p>{{ error() }}</p>
        <ion-button (click)="loadCollections()">Retry</ion-button>
      </div>
      } @else if (filteredCollections().length === 0) {
      <div class="emptyState">
        <p>No collections found</p>
      </div>
      } @else {
      <ion-list>
        @for (collection of filteredCollections(); track collection) {
        <ion-item button
                  (click)="selectCollection(collection); menu?.close();"
                  [class.selectedCollection]="selectedCollection() === collection">
          <ion-label>{{ collection }}</ion-label>
        </ion-item>
        }
      </ion-list>
      }
    </ion-content>
  </ion-menu>

  <!-- Main Content - Documents List -->
  <div class="ion-page"
       id="main-content">
    <ion-header>
      <ion-toolbar>
        <ion-menu-button slot="start"></ion-menu-button>
        <ion-title>
          @if (selectedCollection()) {
          {{ selectedCollection() }}
          } @else {
          Select a Collection
          }
        </ion-title>
        @if (selectedCollection()) {
        <ion-buttons slot="end">
          <ion-button (click)="toggleFilters()">
            <ion-icon slot="icon-only"
                      name="filter-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        }
      </ion-toolbar>
    </ion-header>

    <ion-content>
      @if (selectedCollection()) {
      <ion-refresher slot="fixed"
                     (ionRefresh)="handleDocumentsRefresh($event)">
        <ion-refresher-content></ion-refresher-content>
      </ion-refresher>

      <ion-header collapse="condense">
        <ion-toolbar>
          <ion-title size="large">{{ selectedCollection() }}</ion-title>
        </ion-toolbar>
      </ion-header>

      <!-- Filters Section -->
      @if (showFilters()) {
      <div class="filtersContainer">
        <div class="filterInputs">
          <div class="fieldInputWrapper">
            <ion-item class="filterInput">
              <ion-input [value]="newFilterField()"
                         (ionInput)="newFilterField.set($any($event.target).value)"
                         (ionFocus)="onFieldFocus()"
                         (ionBlur)="onFieldBlur()"
                         placeholder="Field name"
                         label="Field"
                         labelPlacement="floating"></ion-input>
            </ion-item>
            @if (showFieldAutocomplete() && filteredFields().length > 0) {
            <div class="autocompleteDropdown">
              @for (field of filteredFields(); track field) {
              <div class="autocompleteItem"
                   (click)="selectField(field)">
                {{ field }}
              </div>
              }
            </div>
            }
          </div>
          <ion-item class="filterInput operatorInput">
            <ion-select [value]="newFilterOperator()"
                        (ionChange)="newFilterOperator.set($any($event.detail).value)"
                        label="Operator"
                        labelPlacement="floating"
                        interface="popover">
              @for (op of availableOperators(); track op.value) {
              <ion-select-option [value]="op.value">{{ op.label }}</ion-select-option>
              }
            </ion-select>
          </ion-item>
          <ion-item class="filterInput">
            <ion-input [value]="newFilterValue()"
                       (ionInput)="newFilterValue.set($any($event.target).value)"
                       placeholder="Filter value"
                       label="Value"
                       labelPlacement="floating"
                       (keyup.enter)="addFilter()"></ion-input>
          </ion-item>
          <ion-button (click)="addFilter()"
                      [disabled]="!newFilterField() || !newFilterValue()"
                      class="addFilterButton">
            <ion-icon slot="icon-only"
                      name="add"></ion-icon>
          </ion-button>
        </div>

        @if (filters().length > 0) {
        <div class="activeFilters">
          @for (filter of filters(); track $index) {
          <ion-chip class="filterChip">
            <ion-label>{{ filter.field }} {{ filter.operator }} {{ filter.value }}</ion-label>
            <ion-icon name="close"
                      (click)="removeFilter($index)"></ion-icon>
          </ion-chip>
          }
        </div>
        }
      </div>
      }

      @if (documentsLoading() && documents().length === 0) {
      <div class="loadingContainer">
        <ion-spinner></ion-spinner>
      </div>
      } @else if (documentsError()) {
      <div class="emptyState">
        <p>{{ documentsError() }}</p>
        @if (selectedCollection()) {
        <ion-button (click)="loadDocuments(selectedCollection()!)">Retry</ion-button>
        }
      </div>
      } @else if (documents().length === 0) {
      <div class="emptyState">
        <p>No documents found</p>
      </div>
      } @else {
      <ion-list>
        @for (doc of documents(); track doc._id) {
        @if (doc._id) {
        <ion-item button
                  class="documentItem"
                  (click)="viewDocument(doc._id)">
          <ion-label>
            @if (getDocumentName(doc)) {
            <h2>{{ getDocumentName(doc) }}</h2>
            @if (getDocumentEmail(doc)) {
            <p>{{ getDocumentEmail(doc) }}</p>
            }
            } @else {
            <h2>{{ doc._id }}</h2>
            }
          </ion-label>
          @if (getDocumentUpdateDate(doc)) {
          <ion-note slot="end"
                    class="dateLabel">
            <p>{{ getDocumentUpdateDate(doc) }}</p>
          </ion-note>
          }

        </ion-item>
        }
        }
      </ion-list>

      @if (pagination()?.hasMore) {
      <ion-infinite-scroll (ionInfinite)="loadMore($event)">
        <ion-infinite-scroll-content></ion-infinite-scroll-content>
      </ion-infinite-scroll>
      }
      }
      } @else {
      <div class="emptyState">
        <p>Select a collection from the left to view its documents</p>
      </div>
      }
    </ion-content>
  </div>
</ion-split-pane>